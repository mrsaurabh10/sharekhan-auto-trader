<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <!-- CSRF tokens injected by controller model (_csrf) -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <meta name="_csrf_parameter" th:content="${_csrf.parameterName}" />
    <title>Admin Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 1.5rem; }
        .users-list { float: left; width: 220px; border-right: 1px solid #ddd; padding-right: 1rem; }
        .users-list ul { list-style: none; padding: 0; }
        .users-list li { padding: 0.4rem; cursor: pointer; border-radius: 4px; }
        .users-list li:hover { background: #f0f0f0; }
        .users-list li.active { background: #e6f0ff; font-weight: bold; }
        .content { margin-left: 240px; }
        table { border-collapse: collapse; width: 100%; }
        table, th, td { border: 1px solid #ccc; }
        th, td { padding: 0.5rem; text-align: left; }
        .small { width: 120px; }
        .form-row { margin-bottom: 0.5rem; }
        .inline { display: inline-block; margin-right: 0.5rem; }
        .btn { padding: 0.4rem 0.6rem; cursor: pointer; }
        .btn.primary { background: #2b7cff; color: white; border: none; }
        .btn.danger { background: #ff5c5c; color: white; border: none; }
        .muted { color: #666; font-size: 0.9rem; }
    </style>
</head>
<body>
<h2>Admin Dashboard</h2>
<div style="display:flex">
    <div class="users-list">
        <h4>Users</h4>
        <div style="margin-bottom:0.6rem;">
            <input id="newUserName" placeholder="username" style="width:100%; margin-bottom:0.25rem;" />
            <input id="newUserCustomerId" placeholder="customerId (numeric)" style="width:100%; margin-bottom:0.25rem;" />
            <button class="btn primary" id="createUserBtn" style="width:100%;">Add User</button>
        </div>
        <div id="usersContainer">Loading users...</div>
        <div style="margin-top:0.5rem">
            <button class="btn" id="runUsersDiagBtn" style="width:100%">Run users diagnostics</button>
            <div id="usersDiagOutput" style="margin-top:0.5rem;font-size:0.9rem;color:#333"></div>
        </div>
    </div>
    <div class="content">
        <!-- selected user title removed to avoid duplicate label (place-order iframe shows its own header) -->

        <!-- User tabs -->
        <div id="userTabs" style="margin-bottom:0.75rem;display:flex;gap:6px;flex-wrap:wrap"></div>

        <!-- Per-user area: embed full Place Order page in an iframe so admin can use full feature-rich UI -->
        <div id="userContent" style="display:none">
            <div id="placeOrderPanel" style="border:1px solid #eee;padding:0.2rem;margin-bottom:0.8rem;background:#fbfbff;">
                <h4>Place Order (full UI)</h4>
                <iframe id="placeOrderIframe" src="about:blank" style="width:100%;height:640px;border:1px solid #ddd;" title="Place Order"></iframe>
            </div>

            <div style="display:flex;gap:16px;">
                <div style="flex:1">
                    <h4>Trading Requests</h4>
                    <table id="user-requests-table" style="width:100%;border-collapse:collapse" border="1">
                        <thead><tr><th>ID</th><th>Symbol</th><th>Exchange</th><th>Entry</th><th>SL</th><th>T1</th><th>Qty</th><th>Status</th><th>Action</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div style="flex:1">
                    <h4>Trades Executed</h4>
                    <table id="user-executed-table" style="width:100%;border-collapse:collapse" border="1">
                        <thead><tr><th>ID</th><th>Symbol</th><th>Exchange</th><th>Entry</th><th>SL</th><th>T1</th><th>Qty</th><th>Status</th><th>Action</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <section id="brokersSection" style="display:none">
            <h4>Brokers for user <span id="selectedUserId"></span></h4>
            <div style="margin-bottom:0.5rem">
                <button class="btn primary" id="refreshBrokersBtn">Refresh</button>
                <button class="btn" id="showAddBrokerBtn">Add Broker</button>
            </div>

            <div id="addBrokerForm" style="display:none; border:1px solid #eee; padding:0.6rem; margin-bottom:0.6rem; background:#fafafa;">
                <div class="form-row"><label class="inline small">Broker Name</label><input id="b_brokerName" /></div>
                <div class="form-row"><label class="inline small">Customer ID</label><input id="b_customerId" placeholder="numeric customerId" /></div>
                <div class="form-row"><label class="inline small">API Key</label><input id="b_apiKey" /></div>
                <div class="form-row"><label class="inline small">Broker Username</label><input id="b_brokerUser" /></div>
                <div class="form-row"><label class="inline small">Broker Password</label><input id="b_brokerPw" type="password"/></div>
                <div class="form-row"><label class="inline small">Client Code</label><input id="b_clientCode" /></div>
                <div class="form-row"><label class="inline small">TOTP Secret</label><input id="b_totp" /></div>
                <div class="form-row"><label class="inline small">Secret Key</label><input id="b_secret" /></div>
                <div class="form-row"><label class="inline small">Active</label><input id="b_active" type="checkbox" checked /></div>
                <div>
                    <button class="btn primary" id="addBrokerSubmit">Save</button>
                    <button class="btn" id="addBrokerCancel">Cancel</button>
                </div>
            </div>

            <table id="brokersTable">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Broker</th>
                    <th>Customer ID</th>
                    <th>Client Code</th>
                    <th>Has API Key</th>
                    <th>Active</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>

            <div id="brokerEditor" style="display:none; margin-top:0.8rem; border:1px solid #eee; padding:0.6rem; background:#fff6e6;">
                <h4>Edit Broker <span id="editBrokerIdLbl"></span></h4>
                <div class="form-row"><label class="inline small">Broker Name</label><input id="e_brokerName" /></div>
                <div class="form-row"><label class="inline small">Customer ID</label><input id="e_customerId" placeholder="numeric customerId" /></div>
                <div class="form-row"><label class="inline small">API Key</label><input id="e_apiKey" /></div>
                <div class="form-row"><label class="inline small">Broker Username</label><input id="e_brokerUser" /></div>
                <div class="form-row"><label class="inline small">Broker Password</label><input id="e_brokerPw" type="password"/></div>
                <div class="form-row"><label class="inline small">Client Code</label><input id="e_clientCode" /></div>
                <div class="form-row"><label class="inline small">TOTP Secret</label><input id="e_totp" /></div>
                <div class="form-row"><label class="inline small">Secret Key</label><input id="e_secret" /></div>
                <div class="form-row"><label class="inline small">Active</label><input id="e_active" type="checkbox"/></div>
                <div>
                    <button class="btn primary" id="saveBrokerBtn">Save</button>
                    <button class="btn" id="cancelEditBrokerBtn">Cancel</button>
                </div>
            </div>

        </section>

    </div>
</div>

<script>
    let selectedUserId = null;
    let selectedCustomerId = null;

    // Centralized selection helper: updates UI state and loads per-user data exactly once
    function showUserSelection(appUserId, customerId, displayText, clickedElem) {
        try {
            // set globals
            window.selectedUserId = appUserId;
            window.selectedCustomerId = (customerId == null || customerId === 'null' || customerId === '') ? appUserId : customerId;
            // update visible labels
            const selUserIdEl = document.getElementById('selectedUserId'); if (selUserIdEl) selUserIdEl.innerText = window.selectedUserId;
            const titleEl = document.getElementById('selectedUserTitle'); if (titleEl) titleEl.innerText = (displayText ? 'User: ' + displayText : 'User: ' + appUserId);

            // show content sections
            const userContent = document.getElementById('userContent'); if (userContent) userContent.style.display = 'block';
            const brokersSection = document.getElementById('brokersSection'); if (brokersSection) brokersSection.style.display = 'block';

            // mark active in user list
            try { document.querySelectorAll('#usersContainer ul li').forEach(x => x.classList.remove('active')); } catch (e) {}
            try { if (clickedElem) clickedElem.classList.add('active'); } catch (e) {}

            // set iframe
            try {
                const iframe = document.getElementById('placeOrderIframe');
                if (iframe) {
                    const uid = (window.selectedCustomerId != null) ? window.selectedCustomerId : window.selectedUserId;
                    iframe.src = '/place-order' + (uid ? ('?userId=' + encodeURIComponent(uid)) : '');
                }
            } catch (e) { console.debug('setting placeOrderIframe src failed', e); }

            // Load data once
            try { if (window.loadRequestedOrdersForUser) window.loadRequestedOrdersForUser(appUserId); } catch (e) { console.debug('loadRequestedOrdersForUser failed', e); }
            try { if (window.loadExecutedForUser) window.loadExecutedForUser(appUserId); } catch (e) { console.debug('loadExecutedForUser failed', e); }
            try { if (window.loadBrokers) window.loadBrokers(appUserId); } catch (e) { console.debug('loadBrokers failed', e); }
        } catch (e) { console.debug('showUserSelection failed', e); }
    }

    // Named global functions for legacy inline handlers: delegate to central helper
    function selectUser(appUserId, elem) {
        try { showUserSelection(appUserId, elem && elem.dataset ? elem.dataset.customerId : null, elem ? elem.innerText : null, elem); } catch (e) { console.debug('selectUser wrapper failed', e); }
    }

    function selectUserWithCustomer(appUserId, customerId, btnElem) {
        try { showUserSelection(appUserId, customerId, btnElem ? btnElem.innerText : null, btnElem); } catch (e) { console.debug('selectUserWithCustomer wrapper failed', e); }
    }

    // Ensure CSRF meta tags exist; if not, fetch from server endpoint and populate them.
    async function ensureCsrf() {
        try {
            const meta = document.querySelector('meta[name="_csrf"]');
            if (meta && meta.getAttribute('content')) return; // already present
            // fetch from backend endpoint
            const res = await fetch('/admin/csrf-token', { credentials: 'include' });
            if (!res.ok) return;
            const body = await res.json();
            if (!body || !body.token) return;
            // create/update meta tags
            function setMeta(name, value) {
                let m = document.querySelector('meta[name="' + name + '"]');
                if (!m) {
                    m = document.createElement('meta');
                    m.setAttribute('name', name);
                    document.head.appendChild(m);
                }
                m.setAttribute('content', value);
            }
            setMeta('_csrf', body.token);
            setMeta('_csrf_header', body.header || 'X-CSRF-TOKEN');
            setMeta('_csrf_parameter', body.parameter || '_csrf');
        } catch (e) {
            console.debug('Could not ensure CSRF token from server', e);
        }
    }

    async function fetchJson(url, opts) {
        opts = opts || {};
        // ensure cookies/session are sent
        if (!opts.credentials) opts.credentials = 'include';
        // attach CSRF header automatically when available
        try {
            const csrfTokenMeta = document.querySelector('meta[name="_csrf"]');
            const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');
            if (!opts.headers) opts.headers = {};
            if (csrfTokenMeta && csrfHeaderMeta) {
                opts.headers[csrfHeaderMeta.getAttribute('content') || csrfHeaderMeta.content] = csrfTokenMeta.getAttribute('content') || csrfTokenMeta.content;
            }
            // common AJAX header
            opts.headers['X-Requested-With'] = 'XMLHttpRequest';
            // Fallbacks: if no meta-based CSRF present, try common header names using cookie-based token
            if ((!csrfTokenMeta || !csrfHeaderMeta) && !opts.headers['X-CSRF-TOKEN']) {
                // Try cookie named 'XSRF-TOKEN' or 'X-CSRF-TOKEN'
                function getCookie(name) {
                    const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
                    return v ? v.pop() : null;
                }
                const tokenFromCookie = getCookie('XSRF-TOKEN') || getCookie('X-CSRF-TOKEN') || (csrfTokenMeta ? csrfTokenMeta.getAttribute('content') : null);
                if (tokenFromCookie) {
                    opts.headers['X-CSRF-TOKEN'] = tokenFromCookie;
                    opts.headers['X-XSRF-TOKEN'] = tokenFromCookie;
                }
            }
        } catch (e) {
            console.debug('Failed to attach CSRF header', e);
        }

        const res = await fetch(url, opts);
        if (!res.ok) {
            const txt = await res.text().catch(() => '');
            if (res.status === 403) {
                throw new Error('Forbidden (403). You may not be logged in or lack permissions. ' + txt);
            }
            throw new Error('HTTP ' + res.status + ' ' + txt);
        }
        return res.json();
    }

    async function loadUsers() {
        const container = document.getElementById('usersContainer');
        try {
            console.log('loadUsers() start');
            container.innerHTML = 'Loading users... (' + new Date().toLocaleTimeString() + ')';
            const diagOut = document.getElementById('usersDiagOutput'); if (diagOut) diagOut.innerText = '';

        const endpoints = ['/admin/app-users', '/admin/users'];
        let users = null;
        let lastErrMsg = null;

        // small helper to fetch text with a timeout
        async function fetchTextWithTimeout(url, timeoutMs = 7000) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeoutMs);
            try {
                const res = await fetch(url, { credentials: 'include', headers: { 'X-Requested-With': 'XMLHttpRequest' }, signal: controller.signal });
                const txt = await res.text();
                clearTimeout(id);
                return { res, txt };
            } catch (e) {
                clearTimeout(id);
                throw e;
            }
        }

        // Try endpoints and show diagnostics in UI so failures are visible
        const diagnostics = [];
        for (const ep of endpoints) {
            try {
                container.innerHTML = 'Trying ' + ep + ' ...';
                const { res, txt } = await fetchTextWithTimeout(ep, 8000);
                diagnostics.push({ endpoint: ep, status: res.status, snippet: (txt || '').slice(0, 800) });
                if (!res.ok) {
                    lastErrMsg = `HTTP ${res.status} when fetching ${ep}`;
                    console.error(lastErrMsg, txt.slice(0, 300));
                    continue;
                }
                const trimmed = (txt || '').trim();
                if (trimmed.startsWith('<') && trimmed.toLowerCase().includes('<html')) {
                    lastErrMsg = 'Received HTML (likely login page) from ' + ep + '. Redirecting to admin login.';
                    console.error(lastErrMsg);
                    // show diagnostics to user briefly then redirect
                    container.innerHTML = '<div class="muted">' + lastErrMsg + '</div>';
                    try { window.location.href = '/admin/login'; } catch (e) { console.error('Redirect failed', e); }
                    return;
                }
                // parse JSON
                try {
                    const parsed = JSON.parse(txt);
                    if (!Array.isArray(parsed)) {
                        lastErrMsg = 'Invalid JSON shape from ' + ep;
                        console.error(lastErrMsg, parsed);
                        continue;
                    }
                    users = parsed;
                    break;
                } catch (pe) {
                    lastErrMsg = 'Invalid JSON from ' + ep + ': ' + pe.message;
                    console.error(lastErrMsg, txt.slice(0, 500));
                    continue;
                }
            } catch (err) {
                lastErrMsg = err.name === 'AbortError' ? 'Request timed out' : (err.message || String(err));
                diagnostics.push({ endpoint: ep, error: lastErrMsg });
                console.error('Failed to fetch ' + ep + ':', lastErrMsg);
            }
        }

        if (!Array.isArray(users) || users.length === 0) {
            const msg = lastErrMsg ? ('Failed to load users: ' + lastErrMsg) : 'No configured users';
            console.error('loadUsers final failure:', msg, diagnostics);
            // show first diagnostic if present
            let diagHtml = '';
            if (diagnostics.length) {
                diagHtml = '<div style="font-size:0.9rem;color:#444;margin-top:6px">Diagnostics:<ul>' + diagnostics.map(d => '<li><b>' + (d.endpoint||'') + '</b>: ' + (d.status ? 'status=' + d.status : '') + ' ' + (d.error ? d.error : '') + '<pre style="white-space:pre-wrap;max-height:120px;overflow:auto;background:#f3f3f3;padding:6px;border-radius:4px">' + (d.snippet ? d.snippet.replace(/</g,'&lt;') : '') + '</pre></li>').join('') + '</ul></div>';
            }
            container.innerHTML = '<div class="muted">' + msg + ' <a href="/admin/login">Login</a></div>' + diagHtml;
            if (diagOut) diagOut.innerHTML = diagHtml;
            return;
        }

        const ul = document.createElement('ul');
        users.forEach(u => {
            // u is { id, username, customerId }
            const li = document.createElement('li');
            const display = (u.username ? u.username : ('user-'+u.id)) + (u.customerId ? (' ['+u.customerId+']') : '');
            li.innerText = display;
            li.dataset.appUserId = u.id; // store app_user.id for broker API calls
            li.dataset.customerId = u.customerId;
            // Defensive click handler: try available implementations in order, then explicitly refresh lists
            li.addEventListener('click', function () {
                 try {
                     console.debug('User list clicked:', u.id, u.username, u.customerId);
                     // Mark clicked li as active and clear others for visual feedback
                     try { document.querySelectorAll('#usersContainer ul li').forEach(x => x.classList.remove('active')); } catch (e) {}
                     try { li.classList.add('active'); } catch (e) {}

                     if (typeof selectUser === 'function') selectUser(u.id, li);
                     else if (typeof window.selectUser === 'function') window.selectUser(u.id, li);
                     else if (typeof window.selectUserWithCustomer === 'function') window.selectUserWithCustomer(u.id, u.customerId, li);
                     else {
                        // last-resort local update
                        window.selectedUserId = u.id;
                        window.selectedCustomerId = (u.customerId == null || u.customerId === 'null' || u.customerId === '') ? u.id : u.customerId;
                        const selUserIdEl = document.getElementById('selectedUserId'); if (selUserIdEl) selUserIdEl.innerText = window.selectedUserId;
                        const titleEl = document.getElementById('selectedUserTitle'); if (titleEl) titleEl.innerText = 'User: ' + display;
                     }

                    // Data loaders are handled by showUserSelection (called above) â€” avoid redundant calls

                } catch (e) { console.debug('user-list click failed', e); }
            });
            ul.appendChild(li);
        });
        // attach list
        container.innerHTML = '';
        container.appendChild(ul);
        // Auto-select first user after a short defer so any shims can be defined by other scripts
        if (!selectedUserId && users.length > 0) {
            const firstLi = container.querySelector('li');
            if (firstLi) {
                setTimeout(() => { try { firstLi.click(); } catch (e) { console.debug('deferred firstLi click failed', e); } }, 50);
            }
        }
        // render tabs in content area - defensive: if renderUserTabs not yet defined, create minimal tabs
        try {
            if (typeof renderUserTabs === 'function') {
                renderUserTabs(users);
            } else {
                // minimal inline rendering to avoid ReferenceError
                const tabs = document.getElementById('userTabs');
                if (tabs) {
                    tabs.innerHTML = '';
                    (users || []).forEach(u => {
                        const btn = document.createElement('button');
                        btn.className = 'btn';
                        btn.style.padding = '6px 10px';
                        btn.innerText = (u.username ? u.username : ('user-' + u.id)) + (u.customerId ? (' [' + u.customerId + ']') : '');
                        btn.onclick = () => { try { if (window.selectUserWithCustomer) window.selectUserWithCustomer(u.id, u.customerId, btn); else if (window.selectUser) window.selectUser(u.id, btn); } catch (e) { console.debug('inline tab click failed', e); } };
                        tabs.appendChild(btn);
                    });
                }
            }
        } catch (e) { console.debug('renderUserTabs safe call failed', e); }
    } catch (outerErr) {
        console.error('loadUsers outer exception', outerErr);
        container.innerHTML = '<div class="muted">Error loading users: ' + (outerErr && outerErr.message ? outerErr.message : outerErr) + '</div>';
        const diagOut = document.getElementById('usersDiagOutput'); if (diagOut) diagOut.innerText = 'Exception: ' + (outerErr && outerErr.stack ? outerErr.stack : outerErr);
    }
}

// Non-executing reference so editors/indexers detect `loadUsers` usage (no runtime effect)
if (false) { loadUsers(); }

// --- Safety shims ---
if (typeof renderUserTabs !== 'function') {
    window.renderUserTabs = function (users) {
        try {
            const tabs = document.getElementById('userTabs');
            if (!tabs) return;
            tabs.innerHTML = '';
            (users || []).forEach(u => {
                const btn = document.createElement('button');
                btn.className = 'btn';
                btn.style.padding = '6px 10px';
                btn.innerText = (u.username ? u.username : ('user-' + u.id)) + (u.customerId ? (' [' + u.customerId + ']') : '');
                btn.onclick = () => { if (window.selectUserWithCustomer) window.selectUserWithCustomer(u.id, u.customerId, btn); else if (window.selectUser) window.selectUser(u.id, btn); };
                tabs.appendChild(btn);
            });
        } catch (e) { console.debug('renderUserTabs shim failed', e); }
    };
}

if (typeof window.selectUserWithCustomer !== 'function') {
    window.selectUserWithCustomer = function (appUserId, customerId, btnElem) {
        try {
            document.querySelectorAll('#userTabs .btn').forEach(b => b.style.background = '');
            if (btnElem) btnElem.style.background = '#e6f0ff';
            window.selectedUserId = appUserId;
            window.selectedCustomerId = (customerId == null || customerId === 'null' || customerId === '') ? appUserId : customerId;
            const selUserIdEl = document.getElementById('selectedUserId'); if (selUserIdEl) selUserIdEl.innerText = window.selectedUserId;
            const titleEl = document.getElementById('selectedUserTitle'); if (titleEl) titleEl.innerText = 'User: ' + (btnElem ? btnElem.innerText : appUserId);
            const userContent = document.getElementById('userContent'); if (userContent) userContent.style.display = 'block';
            const brokersSection = document.getElementById('brokersSection'); if (brokersSection) brokersSection.style.display = 'block';
            // Load Place Order iframe for this user (use customerId if present else appUserId)
            try {
                const iframe = document.getElementById('placeOrderIframe');
                if (iframe) {
                    const uid = (window.selectedCustomerId != null) ? window.selectedCustomerId : window.selectedUserId;
                    iframe.src = '/place-order' + (uid ? ('?userId=' + encodeURIComponent(uid)) : '');
                }
            } catch (e) { console.debug('setting placeOrderIframe src failed', e); }
            try { if (window.loadRequestedOrdersForUser) loadRequestedOrdersForUser(window.selectedUserId); } catch (e) {}
            try { if (window.loadExecutedForUser) loadExecutedForUser(window.selectedUserId); } catch (e) {}
            try { if (window.loadBrokers) loadBrokers(window.selectedUserId); } catch (e) {}
        } catch (e) { console.debug('selectUserWithCustomer shim failed', e); }
    };
}

// --- Admin UI interactions ---
// Create App User handler
try {
    const createBtn = document.getElementById('createUserBtn');
    if (createBtn) {
        createBtn.addEventListener('click', async function () {
            try {
                const nameEl = document.getElementById('newUserName');
                const custEl = document.getElementById('newUserCustomerId');
                if (!nameEl || !nameEl.value.trim()) { alert('username required'); return; }
                const payload = { username: nameEl.value.trim() };
                if (custEl && custEl.value.trim()) payload.customerId = Number(custEl.value.trim());
                // Ensure CSRF meta is present (fetch if needed) then POST using fetchJson which will attach CSRF
                await ensureCsrf();
                const created = await fetchJson('/admin/app-users', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                console.log('created app user', created);
                // clear inputs
                nameEl.value = '';
                if (custEl) custEl.value = '';
                // Try to append the created user to the existing list so admin sees it immediately.
                try {
                    const container = document.getElementById('usersContainer');
                    const ul = container ? container.querySelector('ul') : null;
                    const display = (created.username ? created.username : ('user-' + created.id)) + (created.customerId ? (' [' + created.customerId + ']') : '');
                    if (ul) {
                        const newLi = document.createElement('li');
                        newLi.innerText = display;
                        newLi.dataset.appUserId = created.id;
                        newLi.dataset.customerId = created.customerId;
                        newLi.addEventListener('click', function () { try { if (window.selectUser) window.selectUser(created.id, newLi); else if (window.selectUserWithCustomer) window.selectUserWithCustomer(created.id, created.customerId, newLi); } catch (e) { console.debug('newLi click failed', e); } });
                        ul.appendChild(newLi);
                        // select it
                        setTimeout(() => { try { newLi.click(); } catch (e) { console.debug('click newLi failed', e); } }, 50);
                    } else {
                        // fallback to reloading the list and selecting
                        await loadUsers();
                        if (created && created.id) {
                            setTimeout(() => {
                                try {
                                    const li = document.querySelector('#usersContainer ul li[data-app-user-id="' + created.id + '"]');
                                    if (li) li.click();
                                } catch (e) { console.debug('auto-select created user failed after reload', e); }
                            }, 200);
                        }
                    }
                } catch (e) {
                    console.debug('append-created-user failed, reloading users', e);
                    await loadUsers();
                }
            } catch (err) {
                console.error('create user failed', err);
                alert('Failed to create user: ' + (err && err.message ? err.message : err));
            }
        });
    }
} catch (e) { console.debug('attach createUserBtn failed', e); }

// New: load Trading Requests for a user and render into table
async function loadRequestedOrdersForUser(userId) {
    // Resolve user id robustly: explicit parameter > selectedUserId > selectedCustomerId
    const uid = (typeof userId !== 'undefined' && userId !== null) ? userId : (window.selectedUserId || window.selectedCustomerId);
     const tbody = document.querySelector('#user-requests-table tbody');
     if (!tbody) return;
     tbody.innerHTML = '';
     if (!uid) {
         tbody.innerHTML = '<tr><td colspan="9" class="muted">No user selected</td></tr>';
         return;
     }
    try {
        const data = await fetchJson('/api/orders/requests?userId=' + encodeURIComponent(uid));
        if (!Array.isArray(data) || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="muted">No requests</td></tr>';
            return;
        }
        // dedupe by id to avoid duplicate rows when backend returns duplicates
        const seen = new Set();
        const uniq = [];
        for (const r of data) {
            const rid = r && (r.id || r.requestId || r.request_id);
            if (!rid) { uniq.push(r); continue; }
            if (seen.has(rid)) continue;
            seen.add(rid);
            uniq.push(r);
        }
        for (const r of uniq) {
             const tr = document.createElement('tr');
             // safe field access
             const id = r.id || '';
             const symbol = r.instrument || r.symbol || r.tradingSymbol || '-';
             const exchange = r.exchange || '-';
             const entry = r.entryPrice != null ? r.entryPrice : (r.entry || '-');
             const sl = r.stopLoss != null ? r.stopLoss : (r.stop_loss || '-');
             const t1 = r.target1 != null ? r.target1 : (r.t1 || '-');
             const qty = r.quantity != null ? r.quantity : (r.qty || '-');
             const status = r.status || r.requestStatus || '-';
             const actionCell = document.createElement('td');
            // Build action buttons: Edit, Move SL to Cost, Cancel, and Trigger (as before)

            // Edit button
            const editBtn = document.createElement('button');
            editBtn.className = 'btn small';
            editBtn.style.marginRight = '6px';
            editBtn.innerText = 'Edit';
            editBtn.addEventListener('click', async function () {
                try {
                    await ensureCsrf();
                    // Prompt user for new values (leave blank to keep existing)
                    const newSL = prompt('New Stop Loss (leave blank to keep):', r.stopLoss != null ? r.stopLoss : '');
                    const newT1 = prompt('New Target1 (leave blank to keep):', r.target1 != null ? r.target1 : '');
                    const newT2 = prompt('New Target2 (leave blank to keep):', r.target2 != null ? r.target2 : '');
                    const newT3 = prompt('New Target3 (leave blank to keep):', r.target3 != null ? r.target3 : '');
                    const newQty = prompt('New Quantity (leave blank to keep):', r.quantity != null ? r.quantity : '');
                    const intradayChoice = confirm('Set Intraday = true? (Cancel = keep current)');

                    const payload = {};
                    if (newSL !== null && newSL !== '') payload.stopLoss = Number(newSL);
                    if (newT1 !== null && newT1 !== '') payload.target1 = Number(newT1);
                    if (newT2 !== null && newT2 !== '') payload.target2 = Number(newT2);
                    if (newT3 !== null && newT3 !== '') payload.target3 = Number(newT3);
                    if (newQty !== null && newQty !== '') payload.quantity = Number(newQty);
                    // Only set intraday when user confirmed; otherwise do not change
                    if (intradayChoice) payload.intraday = true;

                    // If nothing changed, inform
                    if (Object.keys(payload).length === 0) { alert('No changes provided'); return; }

                    const res = await fetchJson('/api/trades/request/' + id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    console.log('Edit request response', res);
                    await loadRequestedOrdersForUser(uid);
                } catch (e) {
                    console.error('Failed to edit request', e);
                    alert('Edit failed: ' + (e && e.message ? e.message : e));
                }
            });
            actionCell.appendChild(editBtn);

            // Move SL to cost button
            const moveBtn = document.createElement('button');
            moveBtn.className = 'btn small';
            moveBtn.style.marginRight = '6px';
            moveBtn.innerText = 'Move SL to Cost';
            moveBtn.addEventListener('click', async function () {
                try {
                    await ensureCsrf();
                    const entryPrice = r.entryPrice != null ? r.entryPrice : (r.entry || null);
                    if (entryPrice == null) { alert('No entry price available to move SL to cost'); return; }
                    const payload = { stopLoss: Number(entryPrice) };
                    const res = await fetchJson('/api/trades/request/' + id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    console.log('Move SL to cost response', res);
                    await loadRequestedOrdersForUser(uid);
                } catch (e) {
                    console.error('Failed to move SL to cost', e);
                    alert('Move SL failed: ' + (e && e.message ? e.message : e));
                }
            });
            actionCell.appendChild(moveBtn);

            // Cancel button
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'btn small danger';
            cancelBtn.style.marginRight = '6px';
            cancelBtn.innerText = 'Cancel';
            cancelBtn.addEventListener('click', async function () {
                try {
                    if (!confirm('Cancel request id ' + id + '?')) return;
                    await ensureCsrf();
                    await fetchJson('/api/trades/cancel-request/' + id + '?userId=' + encodeURIComponent(uid), { method: 'POST' });
                    await loadRequestedOrdersForUser(uid);
                    try { if (window.loadExecutedForUser) loadExecutedForUser(uid); } catch (e) {}
                } catch (e) {
                    console.error('Cancel request failed', e);
                    alert('Cancel failed: ' + (e && e.message ? e.message : e));
                }
            });
            actionCell.appendChild(cancelBtn);

            // Trigger button (keep existing behavior) - only when not already triggered/executed
            if (String(status).toUpperCase() !== 'TRIGGERED' && String(status).toUpperCase() !== 'EXECUTED') {
                const btn = document.createElement('button');
                btn.className = 'btn small';
                btn.innerText = 'Trigger';
                btn.addEventListener('click', async function () {
                    try {
                        btn.disabled = true;
                        await ensureCsrf();
                        await fetchJson('/admin/trigger/' + id, { method: 'POST' });
                        // refresh lists
                        await loadRequestedOrdersForUser(uid);
                        try { if (window.loadExecutedForUser) loadExecutedForUser(uid); } catch (e) {}
                    } catch (e) {
                        console.error('trigger request failed', e);
                        alert('Trigger failed: ' + (e && e.message ? e.message : e));
                    } finally {
                        try { btn.disabled = false; } catch (e) {}
                    }
                });
                actionCell.appendChild(btn);
            }

            tr.innerHTML = `<td>${id}</td><td>${escapeHtml(String(symbol))}</td><td>${escapeHtml(String(exchange))}</td><td>${escapeHtml(String(entry))}</td><td>${escapeHtml(String(sl))}</td><td>${escapeHtml(String(t1))}</td><td>${escapeHtml(String(qty))}</td><td>${escapeHtml(String(status))}</td>`;
            tr.appendChild(actionCell);
            tbody.appendChild(tr);
        }
    } catch (e) {
        console.error('Failed to load requested orders for user', uid, e);
        tbody.innerHTML = '<tr><td colspan="9" class="muted">Error loading requests</td></tr>';
    }
}

// New: load recently executed trades for a user and render into table
async function loadExecutedForUser(userId) {
    // Resolve user id robustly: explicit parameter > selectedUserId > selectedCustomerId
    const uid = (typeof userId !== 'undefined' && userId !== null) ? userId : (window.selectedUserId || window.selectedCustomerId);
     const tbody = document.querySelector('#user-executed-table tbody');
     if (!tbody) return;
     tbody.innerHTML = '';
     if (!uid) {
         tbody.innerHTML = '<tr><td colspan="9" class="muted">No user selected</td></tr>';
         return;
     }
    try {
        const data = await fetchJson('/api/orders/executed?userId=' + encodeURIComponent(uid));
        if (!Array.isArray(data) || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="muted">No executed trades</td></tr>';
            return;
        }
        // dedupe executed trades by id
        const seenExec = new Set();
        const uniqExec = [];
        for (const t of data) {
            const tid = t && (t.id || t.tradeId || t.trade_id);
            if (!tid) { uniqExec.push(t); continue; }
            if (seenExec.has(tid)) continue;
            seenExec.add(tid);
            uniqExec.push(t);
        }
        for (const t of uniqExec) {
             const tr = document.createElement('tr');
             const id = t.id || '';
             const symbol = t.instrument || t.symbol || t.tradingSymbol || '-';
             const exchange = t.exchange || '-';
             const entry = t.entryPrice != null ? t.entryPrice : (t.entry || '-');
             const sl = t.stopLoss != null ? t.stopLoss : (t.stop_loss || '-');
             const t1 = t.target1 != null ? t.target1 : (t.t1 || '-');
             const qty = t.quantity != null ? t.quantity : (t.qty || '-');
             const status = t.status || '-';
             const actionCell = document.createElement('td');
             const forbiddenStatuses = new Set(['REJECTED','EXITED_SUCCESS','EXITED_FAILURE','EXITED']);
             if (!forbiddenStatuses.has(String(status).toUpperCase())) {
                // Edit button - update stopLoss/targets/intraday
                const editBtn = document.createElement('button');
                editBtn.className = 'btn small';
                editBtn.style.marginRight = '6px';
                editBtn.innerText = 'Edit';
                editBtn.addEventListener('click', async function () {
                    try {
                        await ensureCsrf();
                        const newSL = prompt('New Stop Loss (leave blank to keep):', t.stopLoss != null ? t.stopLoss : '');
                        const newT1 = prompt('New Target1 (leave blank to keep):', t.target1 != null ? t.target1 : '');
                        const newT2 = prompt('New Target2 (leave blank to keep):', t.target2 != null ? t.target2 : '');
                        const newT3 = prompt('New Target3 (leave blank to keep):', t.target3 != null ? t.target3 : '');
                        const intradayChoice = confirm('Set Intraday = true? (Cancel = keep current)');
                        const payload = {};
                        if (newSL !== null && newSL !== '') payload.stopLoss = Number(newSL);
                        if (newT1 !== null && newT1 !== '') payload.target1 = Number(newT1);
                        if (newT2 !== null && newT2 !== '') payload.target2 = Number(newT2);
                        if (newT3 !== null && newT3 !== '') payload.target3 = Number(newT3);
                        // include userId when available so server can authorize non-admin updates
                        if (window.selectedUserId) payload.userId = window.selectedUserId;
                        if (Object.keys(payload).length === 0) { alert('No changes provided'); return; }
                        const res = await fetchJson('/api/trades/execution/' + id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        console.log('Execution update response', res);
                        await loadExecutedForUser(window.selectedUserId);
                    } catch (e) {
                        console.error('Failed to update execution', e);
                        alert('Update failed: ' + (e && e.message ? e.message : e));
                    }
                });
                actionCell.appendChild(editBtn);

                // Move SL to cost button
                const moveBtn = document.createElement('button');
                moveBtn.className = 'btn small';
                moveBtn.style.marginRight = '6px';
                moveBtn.innerText = 'Move SL to Cost';
                moveBtn.addEventListener('click', async function () {
                    try {
                        if (!confirm('Move Stop Loss to entry price for trade ' + id + '?')) return;
                        await ensureCsrf();
                        // endpoint expects tradeId path variable
                        const res = await fetchJson('/api/trades/move-sl-to-cost/' + id, { method: 'POST' });
                        console.log('Move SL response', res);
                        await loadExecutedForUser(window.selectedUserId);
                    } catch (e) {
                        console.error('Move SL failed', e);
                        alert('Move SL failed: ' + (e && e.message ? e.message : e));
                    }
                });
                actionCell.appendChild(moveBtn);

                // Close / Square-off button
                const closeBtn = document.createElement('button');
                closeBtn.className = 'btn small danger';
                closeBtn.innerText = 'Close';
                closeBtn.addEventListener('click', async function () {
                    try {
                        if (!confirm('Square off trade ' + id + ' now?')) return;
                        await ensureCsrf();
                        const res = await fetchJson('/api/trades/square-off/' + id, { method: 'POST' });
                        console.log('Square off response', res);
                        // small delay to allow backend to start square-off; then refresh executed list
                        setTimeout(() => { try { loadExecutedForUser(window.selectedUserId); } catch (e) { console.debug('refresh after square-off failed', e); } }, 800);
                    } catch (e) {
                        console.error('Square off failed', e);
                        alert('Square off failed: ' + (e && e.message ? e.message : e));
                    }
                });
                actionCell.appendChild(closeBtn);
             } else {
                actionCell.innerText = '-';
             }
             tr.innerHTML = `<td>${id}</td><td>${escapeHtml(String(symbol))}</td><td>${escapeHtml(String(exchange))}</td><td>${escapeHtml(String(entry))}</td><td>${escapeHtml(String(sl))}</td><td>${escapeHtml(String(t1))}</td><td>${escapeHtml(String(qty))}</td><td>${escapeHtml(String(status))}</td>`;
             tr.appendChild(actionCell);
             tbody.appendChild(tr);
        }
    } catch (e) {
        console.error('Failed to load executed trades for user', uid, e);
        tbody.innerHTML = '<tr><td colspan="9" class="muted">Error loading executed trades</td></tr>';
    }
}

// Small helper to safely escape HTML inserted into cells
function escapeHtml(str) {
    return (str || '').toString().replace(/[&<>"'`]/g, function (s) { return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;","`":"&#96;"})[s]; });
}

// Diagnostics button: re-run loadUsers and show raw endpoints status
try {
    const diagBtn = document.getElementById('runUsersDiagBtn');
    if (diagBtn) diagBtn.addEventListener('click', async () => { try { await loadUsers(); alert('Users refreshed (check list)'); } catch (e) { alert('Failed to refresh users: ' + e); } });
} catch (e) { console.debug('attach diag btn failed', e); }

// Initial load
ensureCsrf();
loadUsers();

// --- Broker management JS ---
async function loadBrokers(userId) {
    try {
        const uid = userId == null ? window.selectedUserId : userId;
        if (!uid) return;
        const tbody = document.querySelector('#brokersTable tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        const data = await fetchJson('/admin/app-users/' + encodeURIComponent(uid) + '/brokers');
        if (!Array.isArray(data) || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="muted">No brokers configured</td></tr>';
            return;
        }
        data.forEach(b => {
            const tr = document.createElement('tr');
            const id = b.id || '';
            const brokerName = b.brokerName || '';
            const customerId = b.customerId != null ? b.customerId : '';
            const clientCode = b.clientCode ? b.clientCode : '';
            const hasApiKey = b.hasApiKey ? 'Yes' : 'No';
            const active = b.active ? 'Yes' : 'No';
            const actionsTd = document.createElement('td');

            const editBtn = document.createElement('button');
            editBtn.className = 'btn small';
            editBtn.innerText = 'Edit';
            editBtn.addEventListener('click', function () {
                // show editor but don't populate secrets (they are encrypted). Allow editing visible fields.
                try {
                    document.getElementById('brokerEditor').style.display = 'block';
                    document.getElementById('editBrokerIdLbl').innerText = id;
                    document.getElementById('e_brokerName').value = brokerName;
                    document.getElementById('e_customerId').value = customerId;
                    document.getElementById('e_clientCode').value = clientCode || '';
                    document.getElementById('e_apiKey').value = '';
                    document.getElementById('e_brokerUser').value = '';
                    document.getElementById('e_brokerPw').value = '';
                    document.getElementById('e_totp').value = '';
                    document.getElementById('e_secret').value = '';
                    document.getElementById('e_active').checked = !!b.active;
                } catch (e) { console.debug('open broker editor failed', e); }
            });
            actionsTd.appendChild(editBtn);

            const delBtn = document.createElement('button');
            delBtn.className = 'btn small danger';
            delBtn.style.marginLeft = '6px';
            delBtn.innerText = 'Delete';
            delBtn.addEventListener('click', async function () {
                if (!confirm('Delete broker id ' + id + '?')) return;
                try {
                    await ensureCsrf();
                    await fetchJson('/admin/brokers/' + id, { method: 'DELETE' });
                    await loadBrokers(uid);
                } catch (e) {
                    alert('Failed to delete broker: ' + (e && e.message ? e.message : e));
                }
            });
            actionsTd.appendChild(delBtn);

            tr.innerHTML = `<td>${id}</td><td>${escapeHtml(brokerName)}</td><td>${escapeHtml(customerId)}</td><td>${escapeHtml(clientCode)}</td><td>${hasApiKey}</td><td>${active}</td>`;
            tr.appendChild(actionsTd);
            tbody.appendChild(tr);
        });
    } catch (e) {
        console.error('loadBrokers failed', e);
    }
}

// Show add broker form
try {
    const showBtn = document.getElementById('showAddBrokerBtn');
    if (showBtn) showBtn.addEventListener('click', function () {
        try {
            document.getElementById('addBrokerForm').style.display = 'block';
            // clear fields
            ['b_brokerName','b_apiKey','b_brokerUser','b_brokerPw','b_clientCode','b_totp','b_secret'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
            document.getElementById('b_active').checked = true;
        } catch (e) { console.debug('show add broker failed', e); }
    });
} catch (e) { console.debug('attach showAddBrokerBtn failed', e); }

// Cancel add
try {
    const cancel = document.getElementById('addBrokerCancel');
    if (cancel) cancel.addEventListener('click', function () { document.getElementById('addBrokerForm').style.display = 'none'; });
} catch (e) { console.debug('attach addBrokerCancel failed', e); }

// Submit add broker
try {
    const submit = document.getElementById('addBrokerSubmit');
    if (submit) submit.addEventListener('click', async function () {
        try {
            const uid = window.selectedUserId;
            if (!uid) { alert('Select a user first'); return; }
            const payload = {
                brokerName: document.getElementById('b_brokerName').value,
                customerId: (document.getElementById('b_customerId').value || '').trim() === '' ? null : Number(document.getElementById('b_customerId').value),
                apiKey: document.getElementById('b_apiKey').value || null,
                brokerUsername: document.getElementById('b_brokerUser').value || null,
                brokerPassword: document.getElementById('b_brokerPw').value || null,
                clientCode: document.getElementById('b_clientCode').value || null,
                totpSecret: document.getElementById('b_totp').value || null,
                secretKey: document.getElementById('b_secret').value || null,
                active: document.getElementById('b_active').checked
            };
            if (!payload.brokerName || payload.brokerName.trim()==='') { alert('brokerName required'); return; }
            await ensureCsrf();
            const res = await fetchJson('/admin/app-users/' + encodeURIComponent(uid) + '/brokers', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            document.getElementById('addBrokerForm').style.display = 'none';
            await loadBrokers(uid);
            alert('Broker added');
        } catch (e) {
            console.error('add broker failed', e);
            alert('Failed to add broker: ' + (e && e.message ? e.message : e));
        }
    });
} catch (e) { console.debug('attach addBrokerSubmit failed', e); }

// Refresh brokers button
try {
    const refBtn = document.getElementById('refreshBrokersBtn');
    if (refBtn) refBtn.addEventListener('click', async () => { try { await loadBrokers(window.selectedUserId); alert('Brokers refreshed'); } catch (e) { alert('Failed to refresh brokers: ' + e); } });
} catch (e) { console.debug('attach refreshBrokersBtn failed', e); }

// Broker editor save/cancel
try {
    const saveBtn = document.getElementById('saveBrokerBtn');
    if (saveBtn) saveBtn.addEventListener('click', async function () {
        try {
            const id = document.getElementById('editBrokerIdLbl').innerText;
            if (!id) return alert('No broker selected');
            const payload = {};
            payload.brokerName = document.getElementById('e_brokerName').value || null;
            const eCust = (document.getElementById('e_customerId').value || '').trim(); if (eCust !== '') payload.customerId = Number(eCust);
            const api = document.getElementById('e_apiKey').value; if (api && api.trim()!=='') payload.apiKey = api;
            const bu = document.getElementById('e_brokerUser').value; if (bu && bu.trim()!=='') payload.brokerUsername = bu;
            const bp = document.getElementById('e_brokerPw').value; if (bp && bp.trim()!=='') payload.brokerPassword = bp;
            const cc = document.getElementById('e_clientCode').value; if (cc && cc.trim()!=='') payload.clientCode = cc;
            const totp = document.getElementById('e_totp').value; if (totp && totp.trim()!=='') payload.totpSecret = totp;
            const secret = document.getElementById('e_secret').value; if (secret && secret.trim()!=='') payload.secretKey = secret;
            payload.active = !!document.getElementById('e_active').checked;
            await ensureCsrf();
            await fetchJson('/admin/brokers/' + id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            document.getElementById('brokerEditor').style.display = 'none';
            await loadBrokers(window.selectedUserId);
            alert('Broker updated');
        } catch (e) { console.error('save broker failed', e); alert('Failed to save broker: ' + (e && e.message ? e.message : e)); }
    });
    const cancelEdit = document.getElementById('cancelEditBrokerBtn'); if (cancelEdit) cancelEdit.addEventListener('click', function () { document.getElementById('brokerEditor').style.display = 'none'; });
} catch (e) { console.debug('attach broker editor handlers failed', e); }

// Listen for messages from child iframe (place-order) to refresh lists when an order is triggered
try {
    window.addEventListener('message', function (ev) {
        try {
            if (!ev || !ev.data) return;
            var msg = ev.data;
            if (msg.type === 'orderTriggered') {
                console.log('Received orderTriggered from iframe for userId=', msg.userId);
                // refresh lists for currently selected user
                try { if (window.loadRequestedOrdersForUser) loadRequestedOrdersForUser(window.selectedUserId); } catch (e) { console.debug('loadRequestedOrdersForUser missing', e); }
                try { if (window.loadExecutedForUser) loadExecutedForUser(window.selectedUserId); } catch (e) { console.debug('loadExecutedForUser missing', e); }
            }
        } catch (e) { console.debug('message handler failed', e); }
    }, false);
} catch (e) { console.debug('attach message listener failed', e); }
</script>
</body>
</html>
