<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <!-- CSRF tokens injected by controller model (_csrf) -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <meta name="_csrf_parameter" th:content="${_csrf.parameterName}" />
    <title>Admin Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 1.5rem; }
        .users-list { float: left; width: 220px; border-right: 1px solid #ddd; padding-right: 1rem; }
        .users-list ul { list-style: none; padding: 0; }
        .users-list li { padding: 0.4rem; cursor: pointer; border-radius: 4px; }
        .users-list li:hover { background: #f0f0f0; }
        .users-list li.active { background: #e6f0ff; font-weight: bold; }
        .content { margin-left: 240px; max-width: 900px; }
        table { border-collapse: collapse; width: 100%; }
        table, th, td { border: 1px solid #ccc; }
        th, td { padding: 0.5rem; text-align: left; }
        .small { width: 120px; }
        .form-row { margin-bottom: 0.5rem; }
        .inline { display: inline-block; margin-right: 0.5rem; }
        .btn { padding: 0.4rem 0.6rem; cursor: pointer; }
        .btn.primary { background: #2b7cff; color: white; border: none; }
        .btn.danger { background: #ff5c5c; color: white; border: none; }
        .muted { color: #666; font-size: 0.9rem; }

        /* Improved Place Order layout v2 */
        #placeOrderPanel { border: 1px solid #eee; padding: 0.6rem; margin-bottom: 0.8rem; background: #fbfbff; }
        #placeOrderPanel h4 { margin: 0 0 0.25rem 0; }
        #placeOrderPanel .subtle { color: #333; margin-bottom: 0.5rem; }
        #serverError { display:none; background:#ffeaea; border:1px solid #ffb6b6; padding:8px; margin: 0 0 8px 0; color:#800 }

        /* Compact grid: single label/input per row */
        .form-grid {
            display: grid;
            grid-template-columns: 140px 1fr;
            gap: 8px 12px;
            align-items: center;
        }
        .form-grid .form-row { display: contents; }
        .form-grid label.inline.small { width: auto; margin-right: 0; text-align: right; white-space: nowrap; color: #222; }
        #placeOrderPanel form input,
        #placeOrderPanel form select { width: 100%; box-sizing: border-box; padding: 6px; }
        #placeOrderPanel form input[type="number"] { text-align: right; }
        .grid-span-all { grid-column: 1 / -1; }
        .section-title { font-weight: bold; color: #1f3a7a; margin-top: 4px; }
        .section-divider { border-top: 1px dashed #d7dcff; height: 1px; margin: 2px 0 6px 0; }
        .hint { font-size: 0.85rem; color: #666; }
        /* On very small screens keep the same two columns layout (label + field) */
        .form-actions { margin-top: 0.5rem; display: flex; gap: 8px; flex-wrap: wrap; }

        /* Keep select + reload button in the same grid cell to avoid misalignment */
        .input-with-btn { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }
        .btn.small { padding: 4px 6px; font-size: 12px; }
    </style>
</head>
<body>
<h2>Admin Dashboard</h2>
<!-- Show server-side dashboard load error, if any -->
<div th:if="${error}" style="background:#ffeaea;border:1px solid #ffb6b6;padding:8px;margin-bottom:8px;color:#800">Error: <span th:text="${error}"></span></div>
<div style="display:flex">
    <div class="users-list">
        <h4>Users</h4>
        <div style="margin-bottom:0.6rem;">
            <input id="newUserName" placeholder="username" style="width:100%; margin-bottom:0.25rem;" />
            <input id="newUserCustomerId" placeholder="customerId (numeric)" style="width:100%; margin-bottom:0.25rem;" />
            <button class="btn primary" id="createUserBtn" style="width:100%;">Add User</button>
        </div>
        <div id="usersContainer">Loading users...</div>
    </div>
    <div class="content">
        <!-- selected user title removed to avoid duplicate label (place-order iframe shows its own header) -->

        <!-- User tabs -->
        <div id="userTabs" style="margin-bottom:0.75rem;display:flex;gap:6px;flex-wrap:wrap"></div>

        <!-- Per-user area: embed full Place Order page in an iframe so admin can use full feature-rich UI -->
        <div id="userContent" style="display:none">
            <div id="placeOrderPanel">
                <h4>Place Order (Admin)</h4>
                <div class="subtle">Placing order for user: <b id="placeOrderSelectedUser">-</b></div>
                <div id="serverError" aria-live="polite"></div>
                <form id="adminPlaceOrderForm" style="margin-bottom:0.5rem">
                    <div class="form-grid">
                        <div class="grid-span-all section-title">Market & Instrument</div>
                        <div class="grid-span-all section-divider"></div>

                        <div class="form-row"><label class="inline small" for="exchange">Exchange</label>
                            <select id="exchange" name="exchange" required>
                                <option value="">Select Exchange</option>
                                <option value="NF">NF</option>
                                <option value="BF">BF</option>
                                <option value="MX">MX</option>
                                <option value="NC">NC</option>
                                <option value="BC">BC</option>
                            </select>
                        </div>
                        <div class="form-row"><label class="inline small" for="instrument">Instrument</label>
                            <div id="instrumentCell" class="input-with-btn">
                                <select id="instrument" name="instrument"><option value="">Select Instrument</option></select>
                                <button type="button" id="reloadInstrumentsBtn" class="btn small" title="Reload instruments">Reload</button>
                            </div>
                        </div>

                        <div class="form-row"><label class="inline small" for="optionType">Option Type</label>
                            <select id="optionType">
                                <option value="CE" selected>Call</option>
                                <option value="PE">Put</option>
                            </select>
                        </div>
                        <div class="form-row"><label class="inline small" for="quantity">Quantity</label><input id="quantity" type="number" value="1" required></div>

                        <div class="form-row"><label class="inline small" for="strikePrice">Strike</label><select id="strikePrice"><option value="">Select Strike</option></select></div>
                        <div class="form-row"><label class="inline small" for="expiry">Expiry</label><select id="expiry"><option value="">Select Expiry</option></select></div>

                        <div class="grid-span-all section-title">Price & Risk</div>
                        <div class="grid-span-all section-divider"></div>

                        <div class="form-row"><label class="inline small" for="entryPrice">Entry Price</label><input id="entryPrice" type="number" step="0.01" placeholder="e.g. 123.45" required></div>
                        <div class="form-row"><label class="inline small" for="stopLoss">Stop Loss</label><input id="stopLoss" type="number" step="0.01" placeholder="e.g. 115.00" required></div>
                        <div class="form-row"><label class="inline small" for="target1">Target1</label><input id="target1" type="number" step="0.01" placeholder="optional"></div>
                        <div class="form-row"><label class="inline small" for="target2">Target2</label><input id="target2" type="number" step="0.01" placeholder="optional"></div>
                        <div class="form-row"><label class="inline small" for="target3">Target3</label><input id="target3" type="number" step="0.01" placeholder="optional"></div>
                        <div class="form-row"><label class="inline small" for="intraday">Intraday</label><input id="intraday" type="checkbox" aria-label="Intraday"></div>
                    </div>
                    <div class="form-actions">
                        <button class="btn primary" id="adminPlaceOrderBtn" type="submit">Place Order</button>
                        <button class="btn" id="adminPlaceOrderReset" type="button">Reset</button>
                    </div>
                </form>
                <div id="result" class="hint"></div>
            </div>

            <div style="margin-top:12px">
                <h4>Trading Requests</h4>
                <table id="user-requests-table" style="width:100%;border-collapse:collapse" border="1">
                    <thead><tr><th>ID</th><th>Symbol</th><th>Exchange</th><th>Strike</th><th>Entry</th><th>SL</th><th>T1</th><th>Qty</th><th>Status</th><th>Action</th><th>LTP</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div style="margin-top:12px">
                <h4>Trades Executed</h4>
                <table id="user-executed-table" style="width:100%;border-collapse:collapse" border="1">
                    <thead><tr><th>ID</th><th>Symbol</th><th>Exchange</th><th>Strike</th><th>Entry</th><th>SL</th><th>T1</th><th>Qty</th><th>Status</th><th>Action</th><th>LTP</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <section id="brokersSection" style="display:none">
            <h4>Brokers for user <span id="selectedUserName"></span></h4>
            <div style="margin-bottom:0.5rem">
                <button class="btn primary" id="refreshBrokersBtn">Refresh</button>
                <button class="btn" id="showAddBrokerBtn">Add Broker</button>
            </div>

            <div id="addBrokerForm" style="display:none; border:1px solid #eee; padding:0.6rem; margin-bottom:0.6rem; background:#fafafa;">
                <div class="form-row"><label class="inline small">Broker Name</label><input id="b_brokerName" /></div>
                <div class="form-row"><label class="inline small">Customer ID</label><input id="b_customerId" placeholder="numeric customerId" /></div>
                <div class="form-row"><label class="inline small">API Key</label><input id="b_apiKey" /></div>
                <div class="form-row"><label class="inline small">Broker Username</label><input id="b_brokerUser" /></div>
                <div class="form-row"><label class="inline small">Broker Password</label><input id="b_brokerPw" type="password"/></div>
                <div class="form-row"><label class="inline small">Client Code</label><input id="b_clientCode" /></div>
                <div class="form-row"><label class="inline small">TOTP Secret</label><input id="b_totp" /></div>
                <div class="form-row"><label class="inline small">Secret Key</label><input id="b_secret" /></div>
                <div class="form-row"><label class="inline small">Active</label><input id="b_active" type="checkbox" checked /></div>
                <div>
                    <button class="btn primary" id="addBrokerSubmit">Save</button>
                    <button class="btn" id="addBrokerCancel">Cancel</button>
                </div>
            </div>

            <table id="brokersTable">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Broker</th>
                    <th>Customer ID</th>
                    <th>Client Code</th>
                    <th>Has API Key</th>
                    <th>Active</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>

            <div id="brokerEditor" style="display:none; margin-top:0.8rem; border:1px solid #eee; padding:0.6rem; background:#fff6e6;">
                <h4>Edit Broker <span id="editBrokerIdLbl"></span></h4>
                <div class="form-row"><label class="inline small">Broker Name</label><input id="e_brokerName" /></div>
                <div class="form-row"><label class="inline small">Customer ID</label><input id="e_customerId" placeholder="numeric customerId" /></div>
                <div class="form-row"><label class="inline small">API Key</label><input id="e_apiKey" /></div>
                <div class="form-row"><label class="inline small">Broker Username</label><input id="e_brokerUser" /></div>
                <div class="form-row"><label class="inline small">Broker Password</label><input id="e_brokerPw" type="password"/></div>
                <div class="form-row"><label class="inline small">Client Code</label><input id="e_clientCode" /></div>
                <div class="form-row"><label class="inline small">TOTP Secret</label><input id="e_totp" /></div>
                <div class="form-row"><label class="inline small">Secret Key</label><input id="e_secret" /></div>
                <div class="form-row"><label class="inline small">Active</label><input id="e_active" type="checkbox"/></div>
                <div>
                    <button class="btn primary" id="saveBrokerBtn">Save</button>
                    <button class="btn" id="cancelEditBrokerBtn">Cancel</button>
                </div>
            </div>

        </section>

    </div>
</div>

<script th:src="@{/admin-dashboard.js(ts=${T(java.lang.System).currentTimeMillis()})}"></script>
</body>
</html>
